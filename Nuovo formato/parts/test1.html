<html>
<head>
	<link rel="stylesheet" type="text/css" href="../style/style.css">
</head>
<body>
	<div class=body>
		<pre>
		package test

		import org.junit.Before
		import org.junit.After
		import org.junit.Test
		import org.junit.Assert.assertTrue
		import kotlinx.coroutines.runBlocking
		import kotlinx.coroutines.delay
		import kotlinx.coroutines.GlobalScope
		import kotlinx.coroutines.launch
		//import mapRoomKotlin.mapUtil
		import it.unibo.kactor.ActorBasic
		import it.unibo.kactor.MsgUtil
		import it.unibo.kactor.MqttUtils
		import it.unibo.kactor.ApplMessage
		import it.unibo.kactor.ApplMessageType
		import it.unibo.waiterengine.Waiterengine

		class TestWaiterPosition {
			var waitermind            : ActorBasic? = null
			var waiterengine		  : ActorBasic? = null
			val initDelayTime     = 3000L
			
			val testStates = java.util.ArrayList<String>()
			val targetStates = listOf("Start", "rest 0,0", "reachDoor", "convoyTable 0,4", "reachHome", "rest 0,0",
				"reachTableOrder 0,0", "trasmit 2,2", "reachHome", "rest 0,0", "reachBar 0,0", "serveTable 6,0", "reachHome", "rest 0,0", "reachTableCollect 0,0",
				"collect 2,2", "convoyExit 2,2", "reachTableClean 6,4", "tableClearing 2,2", "tableSanitizing 2,2", "tableCleaning 2,2", "reachHome", "rest 0,0")
			
			@kotlinx.coroutines.ObsoleteCoroutinesApi
			@kotlinx.coroutines.ExperimentalCoroutinesApi
			@Before
			fun systemSetUp() {
		   		kotlin.concurrent.thread(start = true) {
					it.unibo.ctxtearoom.main()
				}
			}

			@After
			fun terminate() {
				println("%%%  TestWaiter terminate ")
			}
			
			fun checkResource(value: String){
		        if( waitermind != null ){ 
		            println(" --- checkResource --- ${waitermind!!.geResourceRep()}")
		            assertTrue( waitermind!!.geResourceRep() == value)
		        }
		    }
			
			fun delayAndUpdateArray(){
				var s  : String?
				
						s = waitermind!!.geResourceRep()
						if(!testStates.get(testStates.size-1).equals(s))
							testStates.add(s)
				
		    }
			
			@Test
			fun testRobotboundary(){
			 	runBlocking{
					testStates.add("Start");
					
					
		 			while( waitermind == null ){
						println("testWaiterPosition waits for waitermind ... ")
						delay(initDelayTime)  //time for robot to start
						waitermind = it.unibo.kactor.sysUtil.getActor("waitermind")
		 			}
					while(waiterengine == null){
						println("testWaiterPosition waits for waiterengine...")
						delay(initDelayTime)
						waiterengine = it.unibo.kactor.sysUtil.getActor("waiterengine")
					}
					
					
					
					
					
					
					
					MsgUtil.sendMsg(MsgUtil.buildRequest("waitermind","clientEntryRequest","clientEntryRequest","waitermind"),waitermind!!)
		 			for( i in 0..30000/500)
					{
						delayAndUpdateArray()
						delay(500)
					}
					MsgUtil.sendMsg(MsgUtil.buildDispatch("waitermind","clientOrderReady","clientOrderReady","waitermind"),waitermind!!)
					for( i in 0..30000/500)
					{
						delayAndUpdateArray()
						delay(500)
					}
					MsgUtil.sendMsg(MsgUtil.buildDispatch("waitermind","barmanOrderReady","barmanOrderReady","waitermind"),waitermind!!)
					for( i in 0..45000/500)
					{
						delayAndUpdateArray()
						delay(500)
					}
					MsgUtil.sendMsg(MsgUtil.buildDispatch("waitermind","clientPaymentReady","clientPaymentReady","waitermind"),waitermind!!)
					for( i in 0..55000/500)
					{
						delayAndUpdateArray()
						delay(500)
					}
					
					
					println(testStates)
					println(targetStates)
					assertTrue(testStates == targetStates)
					MsgUtil.sendMsg("end","end","end",waitermind!!)
					
					
					
		  		}
			 	println("testWaiterPosition BYE  ")  
			}
		}
		</pre>
	</div>
</body>
</html>
